// ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

import { CATEGORY_CONFIG, getScoreLabel } from '@/data/default-personas';
import type { AnalysisResult, PersonaResult, PersonaCategory } from '@/types';

const SEVERITY_LABEL: Record<string, string> = {
  high: 'é«˜',
  medium: 'ä¸­',
  low: 'ä½',
};

/**
 * åˆ†æçµæœã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã«å¤‰æ›
 */
export function generateMarkdownReport(analysis: AnalysisResult): string {
  const scoreLabel = getScoreLabel(analysis.overallScore);
  const date = new Date(analysis.createdAt).toLocaleString('ja-JP');
  const lines: string[] = [];

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  lines.push('# SiteProbe åˆ†æãƒ¬ãƒãƒ¼ãƒˆ');
  lines.push('');
  lines.push(`- **URL**: ${analysis.url}`);
  lines.push(`- **åˆ†ææ—¥**: ${date}`);
  lines.push(`- **ç·åˆã‚¹ã‚³ã‚¢**: ${analysis.overallScore}/100ï¼ˆ${scoreLabel.label}ï¼‰`);
  lines.push('');

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚³ã‚¢
  lines.push('## ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚³ã‚¢');
  lines.push('');
  lines.push('| ã‚«ãƒ†ã‚´ãƒª | ã‚¹ã‚³ã‚¢ |');
  lines.push('|----------|--------|');
  for (const cs of analysis.categoryScores) {
    lines.push(`| ${cs.label} | ${cs.score}ç‚¹ |`);
  }
  lines.push('');

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ãƒšãƒ«ã‚½ãƒŠã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const grouped = new Map<PersonaCategory, PersonaResult[]>();
  for (const p of analysis.personaResults) {
    if (p.status !== 'completed') continue;
    const list = grouped.get(p.personaCategory) ?? [];
    list.push(p);
    grouped.set(p.personaCategory, list);
  }

  // å„ãƒšãƒ«ã‚½ãƒŠã®è©³ç´°
  lines.push('---');
  lines.push('');

  for (const [category, personas] of grouped) {
    const config = CATEGORY_CONFIG[category];
    const catScore = analysis.categoryScores.find((cs) => cs.category === category);
    lines.push(`## ${config?.label || category}ï¼ˆ${catScore?.score ?? '-'}ç‚¹ï¼‰`);
    lines.push('');

    for (const persona of personas) {
      lines.push(`### ${persona.personaName} - ${persona.score}ç‚¹`);
      lines.push('');
      lines.push(`> ${persona.summary}`);
      lines.push('');

      if (persona.findings.length > 0) {
        lines.push('#### æŒ‡æ‘˜äº‹é …');
        lines.push('');
        for (const finding of persona.findings) {
          const sev = SEVERITY_LABEL[finding.severity] || finding.severity;
          lines.push(`**[${sev}] ${finding.title}**`);
          lines.push('');
          lines.push(finding.description);
          lines.push('');
          if (finding.recommendation) {
            lines.push(`ğŸ’¡ **æ”¹å–„ææ¡ˆ**: ${finding.recommendation}`);
            lines.push('');
          }
          if (finding.codeExample) {
            lines.push('```');
            lines.push(finding.codeExample);
            lines.push('```');
            lines.push('');
          }
        }
      }

      if (persona.thinkingProcess) {
        lines.push('<details>');
        lines.push('<summary>åˆ†æã®æ€è€ƒéç¨‹</summary>');
        lines.push('');
        lines.push(persona.thinkingProcess);
        lines.push('');
        lines.push('</details>');
        lines.push('');
      }
    }
  }

  // ãƒ•ãƒƒã‚¿ãƒ¼
  lines.push('---');
  lines.push('*Generated by SiteProbe - AIå°‚é–€å®¶ãƒãƒ¼ãƒ ã«ã‚ˆã‚‹ã‚µã‚¤ãƒˆåˆ†æ*');

  return lines.join('\n');
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
 */
export function downloadTextFile(content: string, filename: string) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
