# サイト分析AIチームサービス - 要件定義書（最終版）

> **ステータス**: チームレビュー完了・最終確定
> **最終更新**: 2026-02-09
> **バージョン**: 2.0

## 1. サービス概要

### 1.1 基本情報

**サービス名**: SiteProbe（仮）

**コンセプト**: URLを入力するだけで、AI専門家チーム（16ペルソナ）がサイトを多角的に分析し、具体的な改善提案を行うWebサービス

**コスト方針**: 半永久的に無料で運用可能な構成を最優先。最安で最高品質のAI分析を実現する。

**ターゲットユーザー**:
- Webサイト運営者・マーケター
- Web制作会社・フリーランスデザイナー
- スタートアップの非技術者
- SEO担当者

---

## 2. アーキテクチャ

### 2.1 クライアントサイドオーケストレーション方式

サーバーサイドでの一括処理ではなく、ブラウザ側から各ペルソナごとに個別APIリクエストを送信する方式を採用する。

```
┌─────────────────────────────────────────────────┐
│  ブラウザ（クライアント）                          │
│                                                   │
│  ┌───────────────────────────────────────┐        │
│  │  オーケストレーター（p-limit: 同時3-4）  │        │
│  │                                       │        │
│  │  ペルソナA ──→ API /analyze (Edge)     │        │
│  │  ペルソナB ──→ API /analyze (Edge)     │        │
│  │  ペルソナC ──→ API /analyze (Edge)     │        │
│  │  ペルソナD ──→ (待機中...)             │        │
│  │  ...                                  │        │
│  │  ペルソナP ──→ (待機中...)             │        │
│  └───────────────────────────────────────┘        │
│                                                   │
│  Zustand + localStorage persist で状態管理         │
└─────────────────────────────────────────────────┘
         │
         ▼ 各ペルソナごとに個別リクエスト
┌─────────────────────────────────────────────────┐
│  Vercel Edge Runtime                             │
│                                                   │
│  POST /api/analyze                                │
│    - URL検証・SSRF対策                             │
│    - HTMLスクレイピング（fetch + cheerio）           │
│    - PageSpeed Insights API呼び出し                │
│    - Gemini 2.0 Flash API呼び出し                  │
│    - ストリーミングレスポンス返却                     │
│                                                   │
│  POST /api/share                                  │
│    - Vercel KV に分析結果を保存                     │
│    - 共有ID発行                                    │
│                                                   │
│  GET /api/share/[id]                              │
│    - Vercel KV から分析結果を取得                   │
└─────────────────────────────────────────────────┘
```

**方式の利点**:
- Vercel Free Tierのサーバーレス実行時間制限を回避（各リクエスト10秒以内に完了）
- ペルソナごとに独立した処理のため、1つの失敗が他に影響しない
- 完了したペルソナから順次結果を表示できる
- クライアント側で同時実行数を制御可能（p-limitで3-4並列）

### 2.2 技術スタック（確定）

```
Frontend:     Next.js 15 (App Router) + TypeScript + Tailwind CSS + shadcn/ui
Runtime:      Vercel Edge Runtime（Vercel Free Tier対応）
State:        Zustand + localStorage persist
AI:           Gemini 2.0 Flash (Google AI Studio) ← 最安・高品質・無料枠大
Scraping:     fetch + cheerio (HTML解析) ← サーバーレス対応・軽量
Performance:  PageSpeed Insights API ← パフォーマンス指標取得
Chart:        recharts ← レーダーチャート描画
PDF:          @react-pdf/renderer ← クライアントサイドPDF生成
Share:        Vercel KV Free Tier (256MB) ← 共有URL用ストレージ
Storage:      localStorage（分析履歴、最新20件制限）
Parallel:     p-limit ← クライアントサイド同時実行制御
Test:         Vitest + Playwright + MSW
Deploy:       Vercel Free Tier ← Next.jsの自然な選択・月100GB
```

**AI APIコスト比較（選定理由）**:
| API | 入力コスト | 出力コスト | 無料枠 | 品質 |
|-----|-----------|-----------|--------|------|
| **Gemini 2.0 Flash** | $0.10/1M | $0.40/1M | 15 RPM無料 | ◎ |
| Gemini 2.5 Pro | $1.25/1M | $10.00/1M | 5 RPM無料 | ◎◎ |
| GPT-4o-mini | $0.15/1M | $0.60/1M | なし | ○ |
| Claude Haiku 3.5 | $0.80/1M | $4.00/1M | なし | ○ |

→ Gemini 2.0 Flash を基本AIとし、将来的に複数AI対応も検討

**ホスティング比較**:
| サービス | 月額 | 特徴 | 判定 |
|----------|------|------|------|
| **Vercel Free** | 無料 | Next.js最適、100GB/月、Edge Runtime | ◎採用 |
| XSERVER | 有料 | ユーザー保有済み、Node.js対応 | △バックアップ |
| Cloudflare Pages | 無料 | 無制限帯域、SSR制限あり | ○代替案 |

---

## 3. 機能要件

### F-001: URL分析実行

- ユーザーがURLを入力して分析を開始
- Webページのスクレイピング（fetch + cheerioによるHTML解析）
- **PageSpeed Insights API**によるパフォーマンス指標取得（Lighthouse相当のデータ）
  - Core Web Vitals（LCP, FID/INP, CLS）
  - パフォーマンススコア
  - アクセシビリティスコア
  - SEOスコア
  - ベストプラクティススコア
- メタデータ・構造化データの抽出
- 分析開始前に**ペルソナ選択UI**を表示（使用するペルソナを選べる）
- **分析キャンセル機能**: 分析中に「キャンセル」ボタンで中断可能

### F-002: AIペルソナによる分析

- 各ペルソナが専門観点でサイトを分析
- ペルソナごとに独立した分析レポートを生成
- 改善提案には優先度（高/中/低）を付与
- 具体的なコード例・改善案を提示
- **クライアントサイドオーケストレーション**:
  - ブラウザから各ペルソナごとに個別APIリクエスト送信
  - p-limitで同時実行数を3-4に制限
  - 各リクエスト10秒以内に完了
  - 16ペルソナ: 同時3-4並列で順次実行

### F-003: レポート表示

- **サイドバー+メインコンテンツ構成**でペルソナ切り替え（タブではなくサイドバー）
- 総合スコアの算出（100点満点）
- **レーダーチャート**（recharts）でカテゴリ別スコア表示
- 改善提案の一覧表示（優先度順）
- 完了したペルソナから順次結果を表示（全完了を待たない）

### F-004: 分析過程の可視化

- 各ペルソナがどのような観点で分析したかの思考過程を表示
- 「分析プロセス」セクションで各ペルソナの推論ステップを閲覧可能
- ストリーミング表示で分析中もリアルタイムに過程が見える

### F-005: レポートエクスポート

- **@react-pdf/renderer**によるPDFレポート出力（クライアントサイド生成）
  - 全ペルソナの分析結果を統合
  - 分析過程を含む詳細版PDFも選択可能
- JSON形式でのデータエクスポート（プログラム連携用）

### F-006: 結果の共有（共有URL）

- **Vercel KV Free Tier（256MB）**に分析結果を保存
- 分析結果に一意のIDを付与し、共有用URLを生成
- URLをコピーして他者に共有可能
- 共有URLからは閲覧のみ可能（編集不可）
- ~~Base64方式は撤回~~（データサイズ・URL長の制限のため不採用）

### F-007: カスタムペルソナ管理

- ペルソナの新規作成（名前、専門分野、分析観点、アイコン）
- プリセットペルソナの有効/無効切り替え
- ペルソナの編集・削除
- **ペルソナ選択UI**: 分析開始前にどのペルソナを使用するか選択可能
- ペルソナテンプレートの共有（将来）

### F-008: 分析履歴

- localStorageに過去の分析結果を保存
- **最新20件制限**: 20件を超えた場合は古い履歴から自動削除
- 履歴一覧から過去の分析を閲覧
- 同一サイトの時系列での改善推移の確認
- 履歴のクリア機能
- localStorage容量管理: 保存容量を監視し、容量超過時は古い履歴から自動削除

---

## 4. デフォルトペルソナ一覧（16種）

### マーケティング系

| ID | 名前 | 専門分野 | 分析観点 |
|----|------|----------|----------|
| P-01 | マーケティングストラテジスト | マーケティング戦略 | CTA配置、コンバージョン導線、ファネル設計、価値提案の明確さ |
| P-02 | SEOスペシャリスト | 検索エンジン最適化 | メタタグ、構造化データ、内部リンク、キーワード最適化、技術SEO |
| P-03 | コンテンツストラテジスト | コンテンツ戦略 | コピーライティング品質、メッセージング、トーン&ボイス、読みやすさ |
| P-04 | SNSマーケター | ソーシャルメディア | OGP設定、シェアビリティ、SNS連携、バイラル要素 |

### デザイン・UX系

| ID | 名前 | 専門分野 | 分析観点 |
|----|------|----------|----------|
| P-05 | UIデザイナー | ビジュアルデザイン | 配色、タイポグラフィ、レイアウト、ビジュアル階層、一貫性 |
| P-06 | UXリサーチャー | ユーザー体験 | ナビゲーション、情報設計、ユーザーフロー、認知負荷 |
| P-07 | アクセシビリティ専門家 | アクセシビリティ | WCAG準拠、キーボード操作、スクリーンリーダー対応、コントラスト |
| P-08 | モバイルUX専門家 | モバイル体験 | タッチターゲット、モバイルナビ、レスポンシブ品質 |

### 技術系

| ID | 名前 | 専門分野 | 分析観点 |
|----|------|----------|----------|
| P-09 | パフォーマンスエンジニア | Web性能 | Core Web Vitals、読み込み速度、バンドルサイズ、キャッシュ戦略 |
| P-10 | セキュリティアナリスト | Webセキュリティ | HTTPS、セキュリティヘッダー、XSS/CSRF対策、Cookie設定 |
| P-11 | フロントエンドエンジニア | コード品質 | HTML構造、CSS設計、JS品質、レスポンシブ実装 |

### ビジネス系

| ID | 名前 | 専門分野 | 分析観点 |
|----|------|----------|----------|
| P-12 | ブランドコンサルタント | ブランディング | ブランド一貫性、信頼性シグナル、差別化要素 |
| P-13 | コンバージョン最適化担当 | CRO | フォーム最適化、障壁除去、心理トリガー、A/Bテスト提案 |
| P-14 | リーガルアドバイザー | 法的準拠 | プライバシーポリシー、Cookie同意、特商法表記、GDPR |

### ユーザー視点系

| ID | 名前 | 専門分野 | 分析観点 |
|----|------|----------|----------|
| P-15 | 初回訪問者シミュレーター | 第一印象 | 3秒ルール、価値提案の即座の理解、次のアクションの明確さ |
| P-16 | 競合分析アナリスト | 競合調査 | 業界標準との比較、差別化ポイント、市場ポジショニング |

---

## 5. 非機能要件

| 項目 | 要件 |
|------|------|
| 分析品質 | 時間制限なし。ペルソナ個別リクエスト方式により、各リクエスト10秒以内で高品質な分析を実現 |
| 同時分析 | 16ペルソナを同時3-4並列で順次実行（p-limit制御） |
| 進捗表示 | リアルタイムプログレスバー（下記詳細） |
| UI | レスポンシブ（モバイル/タブレット/デスクトップ） |
| アクセシビリティ | WCAG 2.1 AA準拠 |
| 言語 | 日本語UI（将来的に多言語対応） |
| ブラウザ | Chrome/Safari/Firefox/Edge最新版 |
| レート制限 | IPベースで1分に1分析まで |

### 5.1 プログレスバー仕様

- 全体進捗バー: 全ペルソナの分析完了率を表示（例: 3/16ペルソナ完了 = 18.75%）
- 個別ペルソナ進捗: 各ペルソナの状態を表示（待機中 → 分析中 → 完了 / エラー）
- 現在分析中のペルソナ名とステータスメッセージを表示
- 分析完了したペルソナから順次結果を表示（全完了を待たない）
- 経過時間の表示

### 5.2 エラーハンドリングUI

| エラー種別 | ユーザーへの表示 | リカバリ |
|-----------|----------------|---------|
| URL無効 | 「有効なURLを入力してください」 | 入力フォームにフォーカス |
| スクレイピング失敗 | 「サイトにアクセスできませんでした」 | リトライボタン表示 |
| ペルソナ個別エラー | 該当ペルソナに「分析失敗」バッジ | 個別リトライボタン |
| AI API エラー | 「分析サービスが一時的に利用できません」 | 時間をおいてリトライ |
| レート制限超過 | 「分析は1分に1回まで実行できます」 | 残り待機時間を表示 |
| ネットワークエラー | 「ネットワーク接続を確認してください」 | リトライボタン表示 |
| 分析タイムアウト | 「分析がタイムアウトしました」 | リトライボタン表示 |

---

## 6. セキュリティ要件

### 6.1 SSRF対策（Server-Side Request Forgery）

- **プライベートIP除外**: スクレイピング対象URLのIPアドレスを検証し、プライベートIP（10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8, ::1等）へのリクエストをブロック
- **DNS Rebinding対策**: DNS解決後にIPアドレスを再検証し、DNS Rebinding攻撃を防止
- **プロトコル制限**: http/httpsのみ許可。file://, ftp://, data://等のスキームを拒否
- **リダイレクト制限**: リダイレクト先のURLも同様のIP検証を実施（最大3回まで）

### 6.2 プロンプトインジェクション対策

- スクレイピングしたHTML内容をAIに渡す際に、ユーザープロンプトとシステムプロンプトを明確に分離
- HTMLコンテンツはデータとして扱い、命令として解釈されないようサンドボックス化
- AI応答の構造化（JSON Schema指定）により、不正な出力形式を防止

### 6.3 APIキー管理

- Google AI Studio APIキー: Vercel環境変数（`GEMINI_API_KEY`）で管理
- PageSpeed Insights APIキー: Vercel環境変数（`PSI_API_KEY`）で管理
- Vercel KV接続情報: Vercel環境変数で自動管理
- クライアントサイドにAPIキーを露出しない
- `.env.local` はGit管理対象外

### 6.4 XSS対策

- AI応答のHTMLレンダリング時にサニタイズ処理を実施
- ユーザー入力（URL、ペルソナ名等）のエスケープ処理
- Content Security Policy（CSP）ヘッダーの設定
- `dangerouslySetInnerHTML`の使用を最小限に抑制

### 6.5 レート制限

- IPベースで1分に1分析まで
- Edge Runtimeで実装（Vercel Edge Middleware）
- 制限超過時はHTTP 429レスポンスとリトライ可能時刻を返却

---

## 7. UI/デザイン仕様

### 7.1 レイアウト構成

- **サイドバー + メインコンテンツ構成**（タブ切り替えではなくサイドバー）
  - サイドバー: ペルソナ一覧（アイコン + 名前 + ステータス）
  - メインコンテンツ: 選択中のペルソナの分析結果詳細
  - 総合スコア・レーダーチャートはメインコンテンツ上部に配置

### 7.2 カラーパレット

- **プライマリ**: Deep Navy（#1e293b系）
- **アクセント**: Teal（#0d9488系）
- Tailwind CSSのカラーシステムで統一管理

### 7.3 タイポグラフィ

- **英字フォント**: Inter
- **日本語フォント**: Noto Sans JP
- フォントサイズはTailwind CSSのスケールに準拠

### 7.4 ペルソナアイコン

- **アイコンライブラリ**: Lucide Icons
- 各ペルソナカテゴリごとにカラーを割り当て:
  - マーケティング系: 青系
  - デザイン・UX系: 紫系
  - 技術系: 緑系
  - ビジネス系: オレンジ系
  - ユーザー視点系: ピンク系

### 7.5 レーダーチャート

- **ライブラリ**: recharts
- カテゴリ別スコアをレーダーチャートで視覚化
- カテゴリ: マーケティング、デザイン・UX、技術、ビジネス、ユーザー視点
- 各カテゴリは配下ペルソナのスコア平均で算出

---

## 8. 画面構成

```
/                        - ランディングページ（URL入力フォーム + ペルソナ選択UI）
/analyze/:id             - 分析結果ページ（サイドバー + メインコンテンツ）
/analyze/:id/process     - 分析過程詳細ページ
/analyze/:id/export      - エクスポート（PDF/JSON生成）
/share/:shareId          - 共有用閲覧ページ（編集不可）
/personas                - ペルソナ管理ページ
/personas/new            - ペルソナ作成ページ
/personas/:id/edit       - ペルソナ編集ページ
/history                 - 分析履歴ページ
```

---

## 9. ユーザーストーリー

1. **US-001**: ユーザーとして、URLを入力し、使用するペルソナを選択して「分析開始」を押すと、AIチームが分析を開始する
2. **US-002**: ユーザーとして、分析中にプログレスバーで各ペルソナの進捗が見える
3. **US-003**: ユーザーとして、分析中に「キャンセル」ボタンで分析を中断できる
4. **US-004**: ユーザーとして、サイドバーでペルソナを切り替えて各分析結果を閲覧できる
5. **US-005**: ユーザーとして、レーダーチャートでカテゴリ別スコアを視覚的に確認できる
6. **US-006**: ユーザーとして、改善提案を優先度順に確認し、具体的な改善方法を理解できる
7. **US-007**: ユーザーとして、新しいカスタムペルソナを作成して分析に追加できる
8. **US-008**: ユーザーとして、不要なデフォルトペルソナを無効化できる
9. **US-009**: ユーザーとして、過去の分析結果を閲覧し、改善推移を確認できる
10. **US-010**: ユーザーとして、分析結果をPDF/JSON形式でエクスポートできる
11. **US-011**: ユーザーとして、分析結果の共有URLを生成し、他者に送ることができる
12. **US-012**: ユーザーとして、各ペルソナの分析過程（思考プロセス）を詳細に確認できる
13. **US-013**: ユーザーとして、分析過程を含む詳細版PDFをダウンロードできる
14. **US-014**: ユーザーとして、分析履歴から過去の結果をいつでも閲覧できる（最新20件）
15. **US-015**: ユーザーとして、分析失敗したペルソナを個別にリトライできる

---

## 10. テスト戦略

### 10.1 テストツール

| ツール | 用途 |
|--------|------|
| **Vitest** | ユニットテスト・統合テスト |
| **Playwright** | E2Eテスト・クロスブラウザテスト |
| **MSW (Mock Service Worker)** | APIモック（Gemini API、PageSpeed Insights API等） |

### 10.2 テスト方針

- **ユニットテスト（70%）**: ペルソナ分析ロジック、URL検証、SSRF対策、データ変換
- **統合テスト（20%）**: API Route Handler、オーケストレーション制御、Zustand状態管理
- **E2Eテスト（10%）**: URL入力 → 分析完了 → 結果表示の一連フロー

### 10.3 カバレッジ目標

- 全体: 80%以上
- クリティカルパス（分析パイプライン、セキュリティ）: 100%
- 新規コード: 90%以上

---

## 11. 実装計画

### Step 1: プロジェクトセットアップ

- Next.js 15プロジェクト作成（App Router）
- Tailwind CSS + shadcn/ui セットアップ
- TypeScript設定・ディレクトリ構造の構築
- Zustand + localStorage persist 導入
- Vitest + Playwright + MSW セットアップ

### Step 2: データモデル・API設計

- ペルソナスキーマ、分析結果スキーマ定義
- Edge Runtime対応のAPI Route Handler設計
- Gemini API統合設計
- PageSpeed Insights API統合設計
- Vercel KV連携設計（共有URL用）
- SSRF対策モジュール設計

### Step 3: コア機能実装

- URL入力 → SSRF検証 → HTML取得 → AI分析パイプライン
- クライアントサイドオーケストレーター（p-limit制御）
- 16種のデフォルトペルソナプロンプト
- PageSpeed Insights API連携
- カスタムペルソナCRUD
- レート制限（Edge Middleware）

### Step 4: UI実装

- ランディングページ（URL入力フォーム + ペルソナ選択UI）
- 分析結果ページ（サイドバー + メインコンテンツ + レーダーチャート）
- リアルタイムプログレスバー（ストリーミング対応）
- エラーハンドリングUI
- 分析キャンセル機能
- ペルソナ管理ページ
- 分析履歴ページ
- PDF/JSONエクスポート機能
- 共有URL生成・閲覧ページ

### Step 5: テスト・デプロイ

- ユニットテスト（Vitest + MSW）
- E2Eテスト（Playwright）
- SSRF対策テスト
- セキュリティレビュー
- Vercelデプロイ
- 環境変数設定（APIキー等）

---

## 12. 検証方法

1. `npm run dev` でローカル起動し、URL入力から分析完了までの一連フローを確認
2. ペルソナ選択UIで任意のペルソナを選んで分析が実行されることを確認
3. 分析キャンセルが正常に動作することを確認
4. カスタムペルソナの作成・編集・削除が正常に動作することを確認
5. 16ペルソナの並列分析（3-4同時）が正常に完了することを確認
6. モバイル/デスクトップ両方でUIが正しく表示されることを確認
7. 各ペルソナの分析結果が専門分野に沿った内容であることを確認
8. レーダーチャートでカテゴリ別スコアが正しく表示されることを確認
9. PDF/JSONエクスポートが正常に動作することを確認
10. 共有URL生成・閲覧が正常に動作することを確認
11. 分析履歴が最新20件に制限されることを確認
12. SSRF対策（プライベートIPへのリクエスト拒否）が機能することを確認
13. レート制限（1分に1分析）が機能することを確認
14. WCAG 2.1 AA準拠のアクセシビリティチェックが通ることを確認
