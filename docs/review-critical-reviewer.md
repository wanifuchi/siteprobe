# SiteProbe 要件定義 批判的レビュー

**レビュー担当**: critical-reviewer
**レビュー対象**: `/docs/requirements.md`
**判定**: **重大な問題あり - 要件の大幅な修正が必要**

---

## 1. 要件の抜け漏れ

### 1.1 エラー時のユーザー体験が未定義

要件定義にはエラーハンドリングに関する記述が一切ない。以下のシナリオが想定されるが、すべて未定義である。

- **スクレイピング失敗時**: 対象サイトがアクセス拒否（403）、タイムアウト、存在しない（404）場合のユーザーへのフィードバック
- **AI API呼び出し失敗時**: レート制限到達、API障害時のリトライ戦略とフォールバック
- **部分的な分析完了時**: 16ペルソナ中一部のみ成功した場合、結果をどう表示するか
- **ネットワークエラー時**: 分析中にユーザーの接続が切れた場合の復帰手段
- **不正なURL入力**: URLの形式チェック、存在確認、リダイレクトの扱い

これらが定義されていないと、ユーザーは「何が起きたか分からない」状態に陥り、サービスの信頼性を大きく損なう。

### 1.2 レート制限とユーザー管理の欠如

- **ユーザー認証がない**ため、悪意あるユーザーが無制限に分析を実行してGemini APIの無料枠を消費できる
- **リクエスト制限（レートリミット）**の仕組みが未定義。1人のユーザーがAPI枠を独占するリスクがある
- IPベースの制限、CAPTCHA、分析回数制限等の防御策が必要

### 1.3 プライバシーに関する配慮の欠如

- 分析対象URLをどこかにログとして保存するかの方針が未定義
- 共有URLから第三者がどのサイトを分析したか推測できる（情報漏洩）
- ユーザーが自社サイトの弱点を分析した結果が共有URLで漏洩するリスク
- プライバシーポリシー・利用規約ページの要件がない

### 1.4 localStorageの限界に関する考慮不足

- localStorage容量は約5-10MB。16ペルソナ×詳細レポート+思考過程を含む分析結果は1回あたり数百KB。10-20回の分析で容量超過する可能性が高い
- 容量超過時のユーザーへの通知・古いデータの削除ポリシーが未定義
- ブラウザキャッシュクリアでデータが全消失することの警告がない
- クロスデバイスでのアクセスが不可能であることの明記がない

---

## 2. 要件の矛盾・曖昧さ

### 2.1 「時間制限なし」とVercel Free Tierの致命的矛盾

> **非機能要件**: 分析品質 - 時間制限なし。詳細で高品質な分析を優先（目安: 数分程度）

**Vercel Free TierのServerless Functionsは10秒でタイムアウトする。** これは「時間制限なし」「数分程度」という要件と根本的に矛盾する。

- Vercel Free: 10秒タイムアウト
- Vercel Pro（月$20）: 60秒タイムアウト
- Vercel Enterprise: 900秒タイムアウト

「半永久的に無料で運用」と「時間制限なしの高品質分析」は技術的に両立しない。

### 2.2 ストリーミング表示とServerless制約の矛盾

> **F-004**: ストリーミング表示で分析中もリアルタイムに過程が見える

Vercel FreeのServerless FunctionsでServer-Sent Events（SSE）やWebSocketによる長時間のストリーミング接続を維持することは不可能。10秒で接続が切断される。

仮にEdge Functionsを使っても、30秒の制限がある。16ペルソナの分析が「数分」かかるなら、ストリーミングの維持は困難。

### 2.3 16ペルソナ「並列」実行の曖昧さ

> **非機能要件**: 同時分析 - 複数ペルソナの並列実行

「並列」が何を意味するか曖昧。

- **真の並列実行（同時にAPIを呼ぶ）**: 15 RPMの制限に即座に抵触（16リクエスト > 15 RPM）
- **疑似並列（キュー制御で順次実行）**: 1分に15リクエストなら、16ペルソナで最低2分。実際にはレスポンス待ちを含めるとさらに長時間
- **バッチ並列（数個ずつ並列実行）**: Serverless Functionの10秒制限内で完了しない

### 2.4 スクリーンショット取得の技術的裏付けなし

> **F-001**: スクリーンショット取得（デスクトップ/モバイル）

技術スタックに「fetch + cheerio」とあるが、これではスクリーンショットは取得できない。Puppeteer/PlaywrightなどのヘッドレスブラウザランタイムがVercel Freeでは利用困難（メモリ制限1024MB、実行時間10秒）。

### 2.5 Lighthouse指標取得の技術的裏付けなし

> **F-001**: Lighthouse等のパフォーマンス指標取得

LighthouseはNode.jsで実行する場合、ヘッドレスChrome（約400MB以上のメモリ）が必要。Vercel Serverless Functionsでは実行不可能。PageSpeed Insights APIを使う代替案も要件に記載されていない。

---

## 3. コスト面のリスク

### 3.1 Gemini 2.0 Flash無料枠の計算

**無料枠**: 15 RPM（1分あたり15リクエスト）

**1回の分析に必要なリクエスト数**:
- 16ペルソナ × 1リクエスト = 16リクエスト
- **1回の分析で既に15 RPMを超過**

**1日の処理可能数**:
- 仮に順次実行で1ペルソナあたり10秒とすると、16ペルソナで約3分
- 1時間に最大20回の分析（RPM制限考慮）
- 実際にはトークン量制限（TPM）もあるため、さらに少ない

**複数ユーザーが同時利用した場合**:
- 2人が同時に分析を開始すると32リクエスト/分が必要 → 即座にレート制限
- サービスとして公開した場合、数人の同時利用で機能停止

### 3.2 「半永久的に無料」は幻想

以下の理由から、「半永久的に無料」は現実的でない。

| 制約 | 問題 |
|------|------|
| Vercel Free 10秒制限 | AI分析が完了しない |
| Gemini 15 RPM制限 | 16ペルソナ並列が不可能 |
| Vercel Free 100GB帯域 | スクリーンショット含むと消費が速い |
| Gemini無料枠の将来 | Google方針変更で無料枠縮小・廃止リスク |

**現実的な見積もり**: ユーザー数が数十人を超えた時点で、Vercel Pro（$20/月）+ Gemini API有料プラン（従量課金）への移行が不可避。

### 3.3 隠れたコスト

- **スクリーンショットAPI**: 外部サービス利用時の月額コスト
- **PDF生成**: サーバーサイドPDF生成のメモリ・実行時間コスト
- **Supabase移行時**: 無料枠を超えた場合の月額コスト（$25/月〜）
- **ドメイン費用**: カスタムドメインの年間コスト

---

## 4. 競合・市場リスク

### 4.1 既存の無料ツールとの比較

| サービス | 無料 | 主な機能 | SiteProbeとの差別化 |
|----------|------|----------|---------------------|
| Google PageSpeed Insights | 完全無料 | パフォーマンス、SEO、アクセシビリティ | Google公式、高信頼性 |
| Lighthouse（Chrome DevTools） | 完全無料 | 包括的なWeb品質分析 | ブラウザ組み込み、即座に利用可能 |
| GTmetrix | 無料枠あり | パフォーマンス詳細分析 | 業界標準ツール |
| WebPageTest | 完全無料 | 高度なパフォーマンス分析 | 詳細なウォーターフォール分析 |
| Ahrefs Webmaster Tools | 無料枠あり | SEO、バックリンク分析 | 大規模データベース |
| WAVE | 完全無料 | アクセシビリティ分析 | 専門ツールとして信頼性高い |

### 4.2 差別化の弱さ

SiteProbeの差別化ポイントは「AI専門家チームによる多角的分析」だが、以下の問題がある。

- **Gemini 2.0 Flashの分析品質**: 上記の専門ツールは実測値に基づくが、SiteProbeはAIの推論に基づく。測定精度で劣る
- **「AIが分析した」という付加価値**: ChatGPTやGeminiに直接「このサイトを分析して」と聞けば類似の結果が得られる。わざわざ専用サービスを使う動機が弱い
- **16ペルソナの価値**: ユーザーにとって16個の分析レポートを読む時間と労力は大きい。実際に全部読むユーザーは少ないと予想される

### 4.3 ユーザーの利用動機の不明確さ

ターゲットユーザーとして「Webサイト運営者・マーケター」「SEO担当者」が挙げられているが、これらのユーザーは既に上記の無料ツールを使い慣れている。SiteProbeに乗り換える明確な動機が要件定義から読み取れない。

---

## 5. 実現不可能な要件

### 5.1 MVPの機能過多

要件定義のF-001〜F-008すべてをMVPとして実装するのは過剰。以下の優先度の再評価が必要。

**本来のMVP（最小限）**:
- URL入力 → HTML取得 → 3-5ペルソナで分析 → 結果表示
- これだけで動作確認と価値検証が可能

**MVPから除外すべき機能**:
| 機能 | 理由 |
|------|------|
| F-004 分析過程の可視化 | MVP段階では不要。分析結果が見えれば十分 |
| F-005 PDFエクスポート | スクリーンショットや印刷で代替可能 |
| F-006 共有URL | URLコピー&ペーストで代替可能 |
| F-007 カスタムペルソナ | デフォルトペルソナで価値検証してから |
| F-008 分析履歴 | ブラウザのブックマークで代替可能 |

### 5.2 SPA・動的サイトの分析が不可能

fetch + cheerioでは以下のサイトが分析できない。

- **React/Vue/Angularで構築されたSPA**: JavaScriptで描画されるコンテンツが取得不可
- **認証が必要なページ**: ログイン後のページは分析不可
- **CSP（Content Security Policy）で保護されたサイト**: スクレイピング拒否

これはターゲットユーザーの期待と大きく乖離する。現代のWebサイトの多くがSPAまたは動的レンダリングを採用している。

### 5.3 P-16「競合分析アナリスト」は実現困難

「競合分析」には対象サイトだけでなく、同業他社の情報が必要。単一URLの分析では、AIの一般的な知識に基づく推測しかできず、実質的な競合分析にはならない。このペルソナは削除するか、「業界標準との一般的な比較」に範囲を限定すべき。

---

## 6. セキュリティ上の懸念

### 6.1 SSRF（Server-Side Request Forgery）攻撃

**最も重大なセキュリティリスク。** ユーザー入力のURLをサーバーサイドでfetchする設計は、以下の攻撃を可能にする。

```
攻撃例:
- http://localhost:3000/admin (サーバー内部のサービスにアクセス)
- http://169.254.169.254/latest/meta-data/ (クラウドメタデータ取得)
- http://192.168.1.1/ (内部ネットワークのスキャン)
- file:///etc/passwd (ローカルファイルの読み取り)
```

**必須対策（要件定義に含めるべき）**:
- URLのプロトコル制限（http/httpsのみ）
- プライベートIPアドレス範囲のブロック
- リダイレクト先の検証
- DNS解決後のIPアドレス検証（DNS Rebinding対策）

### 6.2 APIキーの管理

Gemini APIキーの管理方法が要件定義に記載されていない。

- 環境変数で管理する旨の明記が必要
- フロントエンドにAPIキーが露出しない設計の確認
- APIキーのローテーション方針

### 6.3 Base64共有URLの情報漏洩リスク

> **F-006**: 結果データをBase64エンコードしてURLパラメータに埋め込み

Base64は暗号化ではない。誰でもデコードして分析結果の全内容を読める。

- URLが長大になり、共有困難（ブラウザのURL長制限は約2000-8000文字）
- 16ペルソナの分析結果をBase64でURLに含めるのは非現実的（数十KB以上のデータ）
- ブラウザ履歴、アクセスログ、リファラーヘッダー経由での情報漏洩
- 共有URLにはIDベース + アクセストークンの設計が必要

### 6.4 ユーザー入力のサニタイゼーション

- URLインジェクション対策
- 分析結果表示時のXSS対策（AI生成テキストにHTMLが含まれる可能性）
- カスタムペルソナ作成時のインジェクション対策（プロンプトインジェクション）

### 6.5 プロンプトインジェクション

カスタムペルソナ機能（F-007）により、ユーザーが任意のプロンプトをGemini APIに送信できる。

- 悪意あるプロンプトによるAIの悪用
- システムプロンプトのリーク
- 意図しない高コストなリクエストの生成

---

## 7. 最も重大な3つのリスク（優先度順）

### リスク1（致命的）: Vercel Free Tierの実行時間制限とAI分析の根本的矛盾

**影響度**: サービスが根本的に動作しない
**発生確率**: 100%

Vercel FreeのServerless Functionsは**10秒**でタイムアウトする。16ペルソナのAI分析が「数分程度」かかる要件とは根本的に両立しない。ストリーミング表示も10秒で接続が切断される。

**「半永久的に無料」のコンセプト自体が技術的に成立しない。**

対策案:
- クライアントサイドから直接Gemini APIを呼ぶ（ただしAPIキー露出問題）
- Cloudflare Workers（CPU時間制限あり、壁時間は30秒）への移行
- Vercel Pro（$20/月）への移行を前提とした設計
- バックグラウンドジョブ + ポーリングのアーキテクチャに変更

### リスク2（重大）: Gemini無料枠の制限による16ペルソナ並列の非現実性

**影響度**: コア機能が期待通りに動作しない
**発生確率**: 100%

15 RPMの制限で16ペルソナの並列実行は物理的に不可能。順次実行にしても、Vercelの10秒制限と複合して問題が深刻化する。複数ユーザーの同時利用でサービスが即座に機能停止する。

対策案:
- MVPではペルソナ数を3-5に削減
- 順次実行でRPM制限を回避（ただしVercel制限と矛盾）
- ユーザーごとの分析回数制限を設ける
- APIキーをユーザー自身に入力させるBYOK（Bring Your Own Key）モデル

### リスク3（重大）: SSRF攻撃によるセキュリティ脆弱性

**影響度**: サーバーインフラの侵害、データ漏洩
**発生確率**: サービス公開直後に攻撃される可能性が高い

ユーザー入力URLをサーバーサイドでfetchする設計は、SSRF攻撃の典型的なターゲット。Vercelの内部ネットワーク、クラウドメタデータへの不正アクセスが可能になる。

対策案:
- URLバリデーション（プロトコル、IP範囲、ドメイン制限）の必須化
- DNS解決後のIPアドレス検証
- fetch先のホワイトリスト/ブラックリスト管理
- アウトバウンドプロキシの導入

---

## 総合評価

| 観点 | 評価 | コメント |
|------|------|----------|
| 要件の完全性 | D | エラーハンドリング、セキュリティ、プライバシーが欠落 |
| 技術的実現性 | D | Vercel Free + Gemini無料枠では中核機能が動作しない |
| コスト計画 | E | 「半永久的に無料」は技術制約と矛盾 |
| 差別化 | C | 既存無料ツールとの明確な差別化が弱い |
| MVP定義 | D | 機能過多、優先度の再評価が必要 |
| セキュリティ | D | SSRF、プロンプトインジェクション等が未対策 |

### 次のアクションとして推奨する事項

1. **Vercel Free Tierの制約を前提としたアーキテクチャの再設計**（クライアントサイドAPI呼び出し or 代替ホスティング）
2. **MVPの大幅な縮小**（3-5ペルソナ、F-001 + F-002 + F-003のみ）
3. **SSRF対策の要件への追加**
4. **Gemini API制限を考慮したリクエスト制御戦略の策定**
5. **「無料運用」の範囲と限界の明確化**（無料で可能な範囲と、有料化が必要になるトリガーの定義）
